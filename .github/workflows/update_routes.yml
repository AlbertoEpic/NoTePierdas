name: Actualizar Lista de Rutas

on:
  push:
    paths:
      - 'rutas/*.gpx' # Se activa solo si subes tracks nuevos

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout del cÃ³digo
        uses: actions/checkout@v3

      - name: Generar rutas.json y copiar tracks
        run: |
          mkdir -p public/ntp/rutas
          cp -f rutas/*.gpx public/ntp/rutas/ || true
          echo "[" > public/ntp/rutas.json
          first=true
          for file in rutas/*.gpx; do
            if [ "$first" = true ]; then
              first=false
            else
              echo "," >> public/ntp/rutas.json
            fi
            filename=$(basename "$file")
            # Limpiamos el nombre para que quede bonito (quita .gpx y guiones)
            pretty_name=$(echo "$filename" | sed 's/\.gpx//' | sed 's/-/ /g' | sed 's/_/ /g')
            echo "  { \"nombre\": \"$pretty_name\", \"archivo\": \"/ntp/rutas/$filename\", \"tipo\": \"senderismo\" }" >> public/ntp/rutas.json
          done
          echo "]" >> public/ntp/rutas.json

      - name: Configurar Git y Subir cambios
        run: |
          git config --global user.name "GitHub Action"
          git config --global user.email "action@github.com"
          git add public/ntp/rutas.json public/ntp/rutas/*.gpx
          git commit -m "Auto-update rutas.json" || exit 0
          git push